<!-- game/index.html -->
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Танковая миссия — игра</title>
<style>
html,body{margin:0;height:100%;background:#0b1220;overflow:hidden;font-family:system-ui}
#wrap{position:fixed;inset:0;display:flex;flex-direction:column}
#hud{height:72px;display:flex;align-items:center;gap:10px;padding:10px;background:rgba(10,18,35,.7)}
#bar{display:flex;gap:8px;flex:1}
.slot{width:46px;height:46px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center}
.slot img{max-width:80%;max-height:80%}
#stage{flex:1;position:relative}
canvas{position:absolute;inset:0;width:100%;height:100%}
</style>
</head>
<body>

<div id="wrap">
  <div id="hud">
    <b style="color:#cfe6ff">Награды:</b>
    <div id="bar"></div>
  </div>
  <div id="stage">
    <canvas id="c"></canvas>
  </div>
</div>

<script>
(() => {
const DEFAULT = {
  boxCount:7,
  difficulty:"normal",
  tankScale:1,
  boxScale:1,
  tankSpeed:2.2,
  bulletSpeed:6.5,
  tankUrl:"https://img.genially.com/66f849d0f7b39c0016fdd814/552d49a1-b37f-40f1-a992-18c2aa55ed84.gif",
  boxUrl:"https://img.genially.com/66f849d0f7b39c0016fdd814/9bfc40ad-c0ef-4bb9-a006-30014520bb33.png",
  fieldUrl:"",
  items:[]
};

let CFG={...DEFAULT};

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
const bar=document.getElementById("bar");

let W,H,DPR=1;
function resize(){
  DPR=Math.min(2,window.devicePixelRatio||1);
  W=canvas.width=canvas.clientWidth*DPR;
  H=canvas.height=canvas.clientHeight*DPR;
}
new ResizeObserver(resize).observe(canvas);

function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

let IMG_TANK,IMG_BOX,IMG_FIELD;
const loadImg=u=>new Promise(r=>{if(!u)return r(null);const i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=u});

let tank={x:0,y:0,w:0,h:0,dx:1,dy:0};
let bullets=[];
let boxes=[];
let reward=0;
const keys=new Set();

function buildSlots(){
  bar.innerHTML="";
  for(let i=0;i<CFG.boxCount;i++){
    const d=document.createElement("div");
    d.className="slot";
    bar.appendChild(d);
  }
  reward=0;
}

function giveReward(){
  const slot=bar.children[reward];
  if(!slot)return;
  const it=CFG.items[reward%CFG.items.length];
  if(it){
    const img=document.createElement("img");
    img.src=it.img;
    slot.appendChild(img);
  }
  reward++;
}

function spawn(){
  boxes=[];
  const tScale=clamp(CFG.tankScale,0.5,5);
  const bScale=clamp(CFG.boxScale,0.5,5);

  tank.w=90*DPR*tScale;
  tank.h=60*DPR*tScale;
  tank.x=30*DPR;
  tank.y=H-tank.h-30*DPR;

  const bw=64*DPR*bScale;
  const bh=bw;

  for(let i=0;i<CFG.boxCount;i++){
    boxes.push({
      x:Math.random()*(W-bw),
      y:Math.random()*(H-bh-80*DPR),
      w:bw,h:bh,alive:true
    });
  }
}

function shoot(){
  bullets.push({
    x:tank.x+tank.w/2,
    y:tank.y+tank.h/2,
    vx:tank.dx*CFG.bulletSpeed*DPR,
    vy:tank.dy*CFG.bulletSpeed*DPR
  });
}

window.addEventListener("keydown",e=>{
  const k=e.key.toLowerCase();
  if(k===" ")shoot();
  keys.add(k);
});
window.addEventListener("keyup",e=>keys.delete(e.key.toLowerCase()));

window.addEventListener("message",e=>{
  if(e.data?.type==="TANK_MISSION_CONFIG")apply(e.data.payload);
});

async function apply(c){
  CFG={...DEFAULT,...c};
  [IMG_TANK,IMG_BOX,IMG_FIELD]=await Promise.all([
    loadImg(CFG.tankUrl),
    loadImg(CFG.boxUrl),
    loadImg(CFG.fieldUrl)
  ]);
  buildSlots();
  spawn();
}

function loop(){
  let dx=0,dy=0;
  if(keys.has("a")||keys.has("arrowleft"))dx=-1;
  if(keys.has("d")||keys.has("arrowright"))dx=1;
  if(keys.has("w")||keys.has("arrowup"))dy=-1;
  if(keys.has("s")||keys.has("arrowdown"))dy=1;

  if(dx||dy){tank.dx=dx;tank.dy=dy;}
  tank.x=clamp(tank.x+dx*CFG.tankSpeed*DPR,0,W-tank.w);
  tank.y=clamp(tank.y+dy*CFG.tankSpeed*DPR,0,H-tank.h);

  bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy});

  bullets.forEach(b=>{
    boxes.forEach(box=>{
      if(box.alive &&
        b.x>box.x&&b.x<box.x+box.w&&
        b.y>box.y&&b.y<box.y+box.h){
          box.alive=false;
          giveReward();
      }
    });
  });

  ctx.clearRect(0,0,W,H);
  if(IMG_FIELD)ctx.drawImage(IMG_FIELD,0,0,W,H);

  boxes.forEach(b=>b.alive&&IMG_BOX&&ctx.drawImage(IMG_BOX,b.x,b.y,b.w,b.h));

  if(IMG_TANK){
    ctx.save();
    if(tank.dx<0){
      ctx.translate(tank.x+tank.w,tank.y);
      ctx.scale(-1,1);
      ctx.drawImage(IMG_TANK,0,0,tank.w,tank.h);
    }else{
      ctx.drawImage(IMG_TANK,tank.x,tank.y,tank.w,tank.h);
    }
    ctx.restore();
  }

  bullets.forEach(b=>{
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(b.x,b.y,4*DPR,0,Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(loop);
}

resize();
apply(DEFAULT);
loop();
})();
</script>
</body>
</html>
