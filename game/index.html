<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Танковая миссия</title>
<style>
html,body{margin:0;height:100%;background:#000}
canvas{display:block;cursor:pointer}
#hud{position:fixed;top:10px;left:10px;display:flex;gap:8px;z-index:10}
#hud img{width:40px;height:40px;object-fit:contain;background:rgba(255,255,255,.2);border-radius:8px}
</style>
</head>
<body>
<div id="hud"></div>
<canvas id="c"></canvas>

<script>
const cfg = JSON.parse(decodeURIComponent(
  new URLSearchParams(location.search).get("config") || "{}"
));

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize(); addEventListener("resize",resize);

// --- АКТИВАЦИЯ В GENIALLY ---
let active=false;
canvas.addEventListener("click",()=>{active=true;});

// --- КАРТИНКИ ---
const tankImg=new Image();
tankImg.src="https://img.genially.com/66f849d0f7b39c0016fdd814/59b10492-4c07-41bd-9331-69042a9d74b9.png";

const boxImg=new Image();
boxImg.src=cfg.boxUrl;

const bgImg=new Image();
if(cfg.bgUrl) bgImg.src=cfg.bgUrl;

// --- ЗВУКИ (ВСТРОЕННЫЕ) ---
const moveSound = new Audio("танк едет.mp3");
moveSound.loop = true;
const shotSound = new Audio("танк стреляет.mp3");

// --- ТАНК ---
const tank={
  x:60,
  y:0,
  speed:0,
  maxSpeed:3,
  accel:0.2,
  w:90,
  h:0 // высота считается автоматически
};

function placeTank(){
  tank.y = canvas.height - 120;
}
placeTank();

// --- ЯЩИКИ ---
const boxes=[];
const boxSize=80;
for(let i=0;i<(cfg.boxCount||5);i++){
  boxes.push({
    x:Math.random()*(canvas.width-boxSize-40)+20,
    y:Math.random()*(canvas.height-boxSize-160)+80,
    alive:true
  });
}

// --- УПРАВЛЕНИЕ ---
const keys={};
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

// --- ПУЛИ ---
const bullets=[];

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(bgImg.complete)
    ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

  // ящики
  boxes.forEach(b=>{
    if(b.alive) ctx.drawImage(boxImg,b.x,b.y,boxSize,boxSize);
  });

  // танк с сохранением пропорций
  if(tankImg.complete){
    const ratio = tankImg.height / tankImg.width;
    tank.h = tank.w * ratio;
    ctx.drawImage(tankImg,tank.x,tank.y,tank.w,tank.h);
  }

  // движение (плавно)
  let moving=false;
  if(active){
    if(keys["ArrowLeft"]||keys["a"]){ tank.speed=-tank.maxSpeed; moving=true; }
    else if(keys["ArrowRight"]||keys["d"]){ tank.speed=tank.maxSpeed; moving=true; }
    else tank.speed*=0.8;

    tank.x+=tank.speed;

    tank.x=Math.max(0,Math.min(canvas.width-tank.w,tank.x));
  }

  // звук движения
  if(moving){
    if(moveSound.paused) moveSound.play();
  }else{
    moveSound.pause();
    moveSound.currentTime=0;
  }

  // выстрел
  if(active && keys[" "]){
    bullets.push({x:tank.x+tank.w,y:tank.y+tank.h/2});
    shotSound.currentTime=0;
    shotSound.play();
    keys[" "]=false;
  }

  // пули
  bullets.forEach(b=>{
    b.x+=8;
    ctx.fillStyle="yellow";
    ctx.fillRect(b.x,b.y,6,4);

    boxes.forEach(box=>{
      if(box.alive &&
         b.x<box.x+boxSize && b.x+6>box.x &&
         b.y<box.y+boxSize && b.y+4>box.y){
        box.alive=false;
        if(cfg.rewards){
          const r=cfg.rewards[hud.children.length];
          if(r){
            const img=new Image(); img.src=r;
            hud.appendChild(img);
          }
        }
      }
    });
  });

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
