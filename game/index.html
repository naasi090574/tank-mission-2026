<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Танковая миссия — игра</title>
  <style>
    html,body{margin:0;height:100%;background:#0b1220;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{position:fixed;inset:0;display:flex;flex-direction:column}
    #hud{
      height:74px; flex:0 0 74px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background:rgba(10,18,35,.72);
      border-bottom:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
      box-sizing:border-box;
    }
    #hud .title{color:#cfe6ff;font-weight:700;font-size:14px;opacity:.9}
    #bar{display:flex;align-items:center;gap:8px;flex:1;overflow:auto;padding-bottom:2px}
    .slot{
      width:48px;height:48px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto; position:relative;
    }
    .slot img{max-width:80%;max-height:80%;image-rendering:auto}
    #hint{color:rgba(210,230,255,.75);font-size:12px;white-space:nowrap}
    #stage{position:relative;flex:1}
    canvas{position:absolute;inset:0;width:100%;height:100%}
    #toast{
      position:absolute;left:12px;bottom:12px;
      padding:10px 12px;border-radius:12px;
      background:rgba(0,0,0,.35);color:#eaf3ff;font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      max-width:70%;
      display:none;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="hud">
      <div class="title">Награды:</div>
      <div id="bar" aria-label="панель предметов"></div>
      <div id="hint">WASD/стрелки — движение • Пробел — выстрел</div>
    </div>
    <div id="stage">
      <canvas id="c"></canvas>
      <div id="toast"></div>
    </div>
  </div>

<script>
(() => {
  // --- DEFAULTS ---
  const DEFAULT_CONFIG = {
    boxCount: 7,               // 1..15
    tankSpeed: 2.2,            // скорость
    bulletSpeed: 6.5,
    tankUrl: "https://img.genially.com/66f849d0f7b39c0016fdd814/552d49a1-b37f-40f1-a992-18c2aa55ed84.gif",
    boxUrl:  "https://img.genially.com/66f849d0f7b39c0016fdd814/9bfc40ad-c0ef-4bb9-a006-30014520bb33.png",
    fieldUrl: "",
    items: [] // [{label:"", img:"url/data:"}, ...]
  };

  let CFG = structuredClone(DEFAULT_CONFIG);

  // --- UI ---
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const bar = document.getElementById("bar");
  const toast = document.getElementById("toast");

  function showToast(text){
    toast.textContent = text;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.style.display="none", 1400);
  }

  // --- Resize ---
  let W=0,H=0, DPR=1;
  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = canvas.getBoundingClientRect();
    W = Math.floor(r.width * DPR);
    H = Math.floor(r.height * DPR);
    canvas.width = W;
    canvas.height = H;
  }
  new ResizeObserver(resize).observe(canvas);
  window.addEventListener("resize", resize);

  // --- Assets loader ---
  function loadImg(url){
    return new Promise((resolve) => {
      if (!url) return resolve(null);
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = url;
    });
  }

  let IMG_TANK=null, IMG_BOX=null, IMG_FIELD=null;

  // --- Game state ---
  const keys = new Set();
  let tank = { x: 120, y: 120, w: 72, h: 48, dirX:1, dirY:0 };
  let bullets = []; // {x,y,vx,vy,r}
  let boxes = [];   // {x,y,w,h,alive:true}
  let rewardIndex = 0;

  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

  function rectsHit(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function spawnBoxes(){
    boxes = [];
    const count = clamp(Math.floor(CFG.boxCount||7), 1, 15);

    // зоны
    const pad = 30 * DPR;
    const bw = 64 * DPR;
    const bh = 64 * DPR;

    // старт танка — сверху слева
    tank.x = 120 * DPR; tank.y = 140 * DPR;
    tank.w = 84 * DPR;  tank.h = 56 * DPR;

    const tries = 400;
    for(let i=0;i<count;i++){
      let placed=false;
      for(let t=0;t<tries && !placed;t++){
        const x = Math.random()*(W - bw - pad*2) + pad;
        const y = Math.random()*(H - bh - pad*2) + pad;
        const box = {x,y,w:bw,h:bh,alive:true};

        // не ставим слишком близко к танку
        const nearTank = rectsHit({x:x-80*DPR,y:y-80*DPR,w:bw+160*DPR,h:bh+160*DPR}, tank);
        if (nearTank) continue;

        // не перекрываем другие ящики
        let ok=true;
        for(const b of boxes){
          if (rectsHit({x:x-20*DPR,y:y-20*DPR,w:bw+40*DPR,h:bh+40*DPR}, b)) { ok=false; break; }
        }
        if(!ok) continue;

        boxes.push(box);
        placed=true;
      }
    }
    showToast(`Ящики: ${boxes.length}`);
  }

  function resetHUD(){
    bar.innerHTML = "";
    rewardIndex = 0;
  }

  function addReward(){
    const slot = document.createElement("div");
    slot.className = "slot";

    const items = Array.isArray(CFG.items) ? CFG.items : [];
    const item = items.length ? items[rewardIndex % items.length] : null;
    rewardIndex++;

    if(item && item.img){
      const im = document.createElement("img");
      im.src = item.img;
      im.alt = item.label || "предмет";
      slot.appendChild(im);
    } else {
      // если предметов нет — просто точка
      slot.textContent = "★";
      slot.style.color = "rgba(240,255,255,.8)";
      slot.style.fontWeight = "800";
      slot.style.fontSize = "18px";
    }

    bar.appendChild(slot);
    bar.scrollLeft = bar.scrollWidth;
  }

  function shoot(){
    const speed = (CFG.bulletSpeed || 6.5) * DPR;
    const dir = {x: tank.dirX, y: tank.dirY};
    // если никуда не “смотрим”, по умолчанию вправо
    if(dir.x===0 && dir.y===0) dir.x=1;

    const r = 5 * DPR;
    bullets.push({
      x: tank.x + tank.w/2,
      y: tank.y + tank.h/2,
      vx: dir.x * speed,
      vy: dir.y * speed,
      r
    });
  }

  // --- Controls ---
  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (["arrowup","arrowdown","arrowleft","arrowright","w","a","s","d"," "].includes(k) || [" "].includes(e.key)) e.preventDefault();
    if (k === " ") shoot();
    keys.add(k);
  }, {passive:false});

  window.addEventListener("keyup", (e) => {
    keys.delete(e.key.toLowerCase());
  });

  // --- Apply config ---
  async function applyConfig(newCfg){
    CFG = { ...DEFAULT_CONFIG, ...newCfg };
    CFG.boxCount = clamp(Math.floor(CFG.boxCount||7), 1, 15);

    [IMG_TANK, IMG_BOX, IMG_FIELD] = await Promise.all([
      loadImg(CFG.tankUrl),
      loadImg(CFG.boxUrl),
      loadImg(CFG.fieldUrl)
    ]);

    resetHUD();
    spawnBoxes();
  }

  // --- Message from editor (live preview) ---
  window.addEventListener("message", (e) => {
    const d = e.data;
    if(!d || d.type !== "TANK_MISSION_CONFIG") return;
    applyConfig(d.payload || {});
  });

  // --- Also allow config in URL (?config=...) ---
  function tryLoadFromURL(){
    try{
      const u = new URL(location.href);
      const raw = u.searchParams.get("config");
      if(!raw) return null;
      return JSON.parse(decodeURIComponent(raw));
    }catch(_){ return null; }
  }

  // --- Render helpers ---
  function drawCover(img){
    if(!img) return;
    const iw = img.naturalWidth, ih = img.naturalHeight;
    if(!iw || !ih) return;
    const scale = Math.max(W/iw, H/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (W - dw)/2, dy = (H - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function drawSprite(img, x,y,w,h){
    if(img){
      ctx.drawImage(img, x, y, w, h);
    } else {
      ctx.fillStyle = "rgba(255,255,255,.18)";
      ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.strokeRect(x,y,w,h);
    }
  }

  // --- Game loop ---
  function tick(){
    // move tank
    const sp = (CFG.tankSpeed || 2.2) * DPR;
    let dx=0,dy=0;
    if(keys.has("arrowleft") || keys.has("a")) dx -= sp;
    if(keys.has("arrowright")|| keys.has("d")) dx += sp;
    if(keys.has("arrowup")   || keys.has("w")) dy -= sp;
    if(keys.has("arrowdown") || keys.has("s")) dy += sp;

    if(dx || dy){
      // направление “куда едем” = “куда смотрим”
      const len = Math.hypot(dx,dy) || 1;
      tank.dirX = dx/len;
      tank.dirY = dy/len;
    }

    tank.x = clamp(tank.x + dx, 0, W - tank.w);
    tank.y = clamp(tank.y + dy, 0, H - tank.h);

    // move bullets
    bullets.forEach(b => { b.x += b.vx; b.y += b.vy; });
    bullets = bullets.filter(b => b.x>-30 && b.x<W+30 && b.y>-30 && b.y<H+30);

    // collisions bullet-box
    for(const b of bullets){
      const br = {x:b.x-b.r, y:b.y-b.r, w:b.r*2, h:b.r*2};
      for(const box of boxes){
        if(!box.alive) continue;
        if(rectsHit(br, box)){
          box.alive = false;
          b.x = -9999; // убрать пулю
          addReward();
          break;
        }
      }
    }
    bullets = bullets.filter(b => b.x>-1000);

    // draw
    ctx.clearRect(0,0,W,H);

    // background
    drawCover(IMG_FIELD);

    // slight overlay for readability
    ctx.fillStyle = "rgba(10,14,28,.18)";
    ctx.fillRect(0,0,W,H);

    // boxes
    for(const box of boxes){
      if(!box.alive) continue;
      drawSprite(IMG_BOX, box.x, box.y, box.w, box.h);
    }

    // tank (без поворота, просто спрайт)
    drawSprite(IMG_TANK, tank.x, tank.y, tank.w, tank.h);

    // bullets
    ctx.fillStyle = "rgba(255,240,220,.95)";
    for(const b of bullets){
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(tick);
  }

  // --- start ---
  resize();
  applyConfig( tryLoadFromURL() || DEFAULT_CONFIG );
  tick();
})();
</script>
</body>
</html>
