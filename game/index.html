<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Танковая миссия</title>
  <style>
    html,body{margin:0;height:100%;background:#071020;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #game{position:fixed;inset:0}
    #hud{
      position:fixed;left:14px;top:10px;right:14px;display:flex;gap:8px;align-items:center;justify-content:space-between;
      pointer-events:none;
    }
    #rewards{display:flex;gap:8px;align-items:center;pointer-events:none}
    .slot{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .slot img{width:100%;height:100%;object-fit:contain}
    #hint{color:rgba(255,255,255,.65);font-size:12px;pointer-events:none}
    #err{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      color:#fff;background:rgba(0,0,0,.55);padding:24px;text-align:center
    }
    canvas{display:block}
  </style>
</head>
<body>
  <div id="hud">
    <div style="display:flex;gap:10px;align-items:center">
      <div style="color:rgba(255,255,255,.75);font-size:13px">Награды:</div>
      <div id="rewards"></div>
    </div>
    <div id="hint">WASD/стрелки — движение • Пробел — выстрел</div>
  </div>

  <canvas id="game"></canvas>
  <div id="err"></div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);

  function showErr(msg){
    const el = document.getElementById('err');
    el.style.display='flex';
    el.innerHTML = '<div style="max-width:720px"><b>Ошибка</b><div style="margin-top:8px;opacity:.9">'+msg+'</div></div>';
  }

  async function loadConfig(){
    // 1) старый режим: ?config=... (ничего не ломаем)
    if (qs.has('config')) {
      try {
        return JSON.parse(decodeURIComponent(qs.get('config')));
      } catch(e){
        showErr('Не удалось прочитать параметр config.');
        throw e;
      }
    }

    // 2) новый режим: ?bin=ID (для загрузок файлов)
    if (qs.has('bin')) {
      const id = qs.get('bin').trim();
      try{
        const url = `https://api.jsonbin.io/v3/b/${encodeURIComponent(id)}/latest?meta=false`;
        const res = await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json(); // meta=false -> сразу JSON рекорд
        return data;
      }catch(e){
        showErr('Не удалось загрузить конфиг из JSONBin (bin='+id+'). Проверь, что бин публичный.');
        throw e;
      }
    }

    // 3) дефолт
    return {
      tankUrl: "https://img.genially.com/66f849d0f7b39c0016fdd814/552d49a1-b37f-40f1-a992-18c2aa55ed84.gif",
      boxUrl:  "https://img.genially.com/66f849d0f7b39c0016fdd814/9bfc40ad-c0ef-4bb9-a006-30014520bb33.png",
      bgUrl: "",
      boxCount: 7,
      tankScale: 1,
      boxScale: 1,
      shotSoundUrl: "",
      hitSoundUrl: "",
      items: []
    };
  }

  function rand(min,max){ return Math.random()*(max-min)+min; }

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    canvas.width = Math.floor(innerWidth*dpr);
    canvas.height= Math.floor(innerHeight*dpr);
    canvas.style.width = innerWidth+'px';
    canvas.style.height= innerHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize);

  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error('img'));
      img.src = src;
    });
  }

  function loadAudio(src){
    if(!src) return null;
    const a = new Audio(src);
    a.preload = 'auto';
    return a;
  }

  function aPlay(a){
    if(!a) return;
    try{ a.currentTime = 0; a.play().catch(()=>{}); }catch(e){}
  }

  function rectsHit(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
  }

  function createSlots(items){
    const wrap = document.getElementById('rewards');
    wrap.innerHTML='';
    const n = Math.max(0, (items && items.length) ? items.length : 8);
    for(let i=0;i<n;i++){
      const s = document.createElement('div');
      s.className='slot';
      wrap.appendChild(s);
    }
  }

  function putReward(imgUrl){
    const wrap = document.getElementById('rewards');
    const slot = [...wrap.children].find(s => !s.querySelector('img'));
    if(!slot) return;
    const img = document.createElement('img');
    img.src = imgUrl;
    slot.appendChild(img);
  }

  function placeBoxes(cfg, boxImg){
    const boxes = [];
    const count = Math.max(1, Math.min(15, Number(cfg.boxCount||7)));
    const scale = Math.max(0.5, Math.min(5, Number(cfg.boxScale||1)));

    const bw = boxImg.width * scale;
    const bh = boxImg.height * scale;

    const pad = 80;
    const tries = 3000;

    for(let i=0;i<count;i++){
      let ok=false, x=0,y=0;
      for(let t=0;t<tries;t++){
        x = rand(pad, innerWidth - pad - bw);
        y = rand(80, innerHeight - pad - bh);
        const cand = {x,y,w:bw,h:bh};
        ok = true;
        for(const b of boxes){
          const dx = (cand.x+cand.w/2) - (b.x+b.w/2);
          const dy = (cand.y+cand.h/2) - (b.y+b.h/2);
          if (Math.hypot(dx,dy) < 90) { ok=false; break; }
        }
        if(ok) break;
      }
      boxes.push({x,y,w:bw,h:bh,alive:true});
    }
    return boxes;
  }

  (async () => {
    const cfg = await loadConfig();

    resize();

    // HUD slots = по количеству наград (или 8)
    createSlots(cfg.items && cfg.items.length ? cfg.items : new Array(8).fill(null));

    // ассеты
    const [tankImg, boxImg] = await Promise.all([
      loadImage(cfg.tankUrl),
      loadImage(cfg.boxUrl)
    ]);

    const bgImg = cfg.bgUrl ? await loadImage(cfg.bgUrl).catch(()=>null) : null;

    const shotSnd = loadAudio(cfg.shotSoundUrl);
    const hitSnd  = loadAudio(cfg.hitSoundUrl);

    // размеры
    const tankScale = Math.max(0.5, Math.min(5, Number(cfg.tankScale||1)));
    const tankW = tankImg.width * tankScale;
    const tankH = tankImg.height * tankScale;

    // старт: нижний левый, но с отступом
    const tank = {
      x: 40,
      y: innerHeight - tankH - 40,
      w: tankW,
      h: tankH,
      dir: 'right',
      speed: 220
    };

    let boxes = placeBoxes(cfg, boxImg);

    const bullets = [];
    const keys = new Set();

    addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d',' '].includes(k) || e.code==='Space'){
        e.preventDefault();
      }
      if(e.code==='Space') keys.add('space'); else keys.add(k);
    }, {passive:false});

    addEventListener('keyup', (e)=>{
      const k = e.key.toLowerCase();
      if(e.code==='Space') keys.delete('space'); else keys.delete(k);
    });

    function shoot(){
      const b = {x:tank.x+tank.w/2, y:tank.y+tank.h/2, r:5, vx:0, vy:0, life:1.3};
      const sp = 520;
      if(tank.dir==='left') b.vx = -sp;
      if(tank.dir==='right') b.vx = sp;
      if(tank.dir==='up') b.vy = -sp;
      if(tank.dir==='down') b.vy = sp;
      bullets.push(b);
      aPlay(shotSnd);
    }

    let shootCd = 0;

    let last = performance.now();
    function loop(now){
      const dt = Math.min(0.033, (now-last)/1000);
      last = now;

      // движение
      let vx=0, vy=0;
      if(keys.has('arrowleft') || keys.has('a')) vx -= 1;
      if(keys.has('arrowright')|| keys.has('d')) vx += 1;
      if(keys.has('arrowup')   || keys.has('w')) vy -= 1;
      if(keys.has('arrowdown') || keys.has('s')) vy += 1;

      if(vx!==0 || vy!==0){
        if(Math.abs(vx) > Math.abs(vy)) tank.dir = vx<0 ? 'left' : 'right';
        else tank.dir = vy<0 ? 'up' : 'down';

        const len = Math.hypot(vx,vy)||1;
        tank.x += (vx/len)*tank.speed*dt;
        tank.y += (vy/len)*tank.speed*dt;
        tank.x = Math.max(0, Math.min(innerWidth - tank.w, tank.x));
        tank.y = Math.max(60, Math.min(innerHeight - tank.h, tank.y));
      }

      // выстрел
      shootCd -= dt;
      if(keys.has('space') && shootCd<=0){
        shoot();
        shootCd = 0.22;
      }

      // пули
      for(let i=bullets.length-1;i>=0;i--){
        const b = bullets[i];
        b.x += b.vx*dt;
        b.y += b.vy*dt;
        b.life -= dt;

        // коллизия с ящиком
        const br = {x:b.x-b.r, y:b.y-b.r, w:b.r*2, h:b.r*2};
        for(const box of boxes){
          if(!box.alive) continue;
          if(rectsHit(br, box)){
            box.alive = false;
            b.life = 0;
            aPlay(hitSnd);

            // награда
            if(cfg.items && cfg.items.length){
              // берем следующую неиспользованную
              const used = document.querySelectorAll('#rewards .slot img').length;
              const item = cfg.items[Math.min(used, cfg.items.length-1)];
              if(item && item.url) putReward(item.url);
            }
            break;
          }
        }

        if(b.life<=0 || b.x<-50 || b.y<-50 || b.x>innerWidth+50 || b.y>innerHeight+50){
          bullets.splice(i,1);
        }
      }

      // рендер
      ctx.clearRect(0,0,innerWidth,innerHeight);

      // фон
      if(bgImg){
        // cover
        const sw = bgImg.width, sh = bgImg.height;
        const rw = innerWidth/sw, rh = innerHeight/sh;
        const r = Math.max(rw,rh);
        const dw = sw*r, dh = sh*r;
        ctx.drawImage(bgImg, (innerWidth-dw)/2, (innerHeight-dh)/2, dw, dh);
      } else {
        // дефолт градиент
        const g = ctx.createLinearGradient(0,0,0,innerHeight);
        g.addColorStop(0,'#071229'); g.addColorStop(1,'#030815');
        ctx.fillStyle=g; ctx.fillRect(0,0,innerWidth,innerHeight);
      }

      // ящики
      for(const box of boxes){
        if(!box.alive) continue;
        ctx.drawImage(boxImg, box.x, box.y, box.w, box.h);
      }

      // танк (повороты простые: отражение/поворот)
      ctx.save();
      ctx.translate(tank.x + tank.w/2, tank.y + tank.h/2);

      if(tank.dir==='left'){
        ctx.scale(-1,1);
      } else if(tank.dir==='up'){
        ctx.rotate(-Math.PI/2);
      } else if(tank.dir==='down'){
        ctx.rotate(Math.PI/2);
      }
      ctx.drawImage(tankImg, -tank.w/2, -tank.h/2, tank.w, tank.h);
      ctx.restore();

      // пули
      ctx.fillStyle='rgba(255,255,255,.9)';
      for(const b of bullets){
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.fill();
      }

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
  })().catch(()=>{});
})();
</script>
</body>
</html>
