<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Танковая миссия</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  canvas {
    display: block;
    background: #000;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* ================== НАСТРОЙКИ ================== */

const config = Object.fromEntries(new URLSearchParams(location.search));

const TANK_URL = config.tankUrl || "https://img.genially.com/66f849d0f7b39c0016fdd814/59b10492-4c07-41bd-9331-69042a9d74b9.png";
const BOX_URL  = config.boxUrl  || "https://img.genially.com/66f849d0f7b39c0016fdd814/9bfc40a.png";
const BG_URL   = config.bgUrl   || "";

const BOX_COUNT = Math.min(15, Math.max(1, Number(config.boxCount || 5)));
const TANK_SCALE = Number(config.tankScale || 1);
const BOX_SCALE  = Number(config.boxScale || 1);
const SPEED = Number(config.speed || 3);

/* ================== CANVAS ================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ================== IMAGES ================== */

const tankImg = new Image();
tankImg.src = TANK_URL;

const boxImg = new Image();
boxImg.src = BOX_URL;

const bgImg = new Image();
if (BG_URL) bgImg.src = BG_URL;

/* ================== OBJECTS ================== */

const tank = {
  x: 120,
  y: canvas.height - 140,
  w: 120 * TANK_SCALE,
  h: 80 * TANK_SCALE,
  dir: "right"
};

const keys = {};
const boxes = [];

/* ================== BOXES ================== */

function spawnBoxes() {
  boxes.length = 0;
  for (let i = 0; i < BOX_COUNT; i++) {
    const size = 80 * BOX_SCALE;
    boxes.push({
      x: Math.random() * (canvas.width - size),
      y: Math.random() * (canvas.height - size),
      size
    });
  }
}
spawnBoxes();

/* ================== INPUT ================== */

window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

/* ================== UPDATE ================== */

function update() {
  let dx = 0, dy = 0;

  if (keys["ArrowLeft"] || keys["a"]) {
    dx = -SPEED;
    tank.dir = "left";
  }
  if (keys["ArrowRight"] || keys["d"]) {
    dx = SPEED;
    tank.dir = "right";
  }
  if (keys["ArrowUp"] || keys["w"]) {
    dy = -SPEED;
    tank.dir = "up";
  }
  if (keys["ArrowDown"] || keys["s"]) {
    dy = SPEED;
    tank.dir = "down";
  }

  tank.x = Math.max(0, Math.min(canvas.width - tank.w, tank.x + dx));
  tank.y = Math.max(0, Math.min(canvas.height - tank.h, tank.y + dy));
}

/* ================== DRAW ================== */

function drawTank() {
  const cx = tank.x + tank.w / 2;
  const cy = tank.y + tank.h / 2;

  let angle = 0;
  let flipX = 1;

  if (tank.dir === "right") {
    angle = 0;
    flipX = 1;
  }
  if (tank.dir === "left") {
    angle = 0;
    flipX = -1; // ← ВОТ ЭТО ИСПРАВЛЕНИЕ
  }
  if (tank.dir === "down") {
    angle = Math.PI / 2;
    flipX = 1;
  }
  if (tank.dir === "up") {
    angle = -Math.PI / 2;
    flipX = 1;
  }

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(angle);
  ctx.scale(flipX, 1);
  ctx.drawImage(tankImg, -tank.w / 2, -tank.h / 2, tank.w, tank.h);
  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (bgImg.src) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  }

  for (const b of boxes) {
    ctx.drawImage(boxImg, b.x, b.y, b.size, b.size);
  }

  drawTank();
}

/* ================== LOOP ================== */

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

</script>
</body>
</html>
